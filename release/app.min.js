/*! slidingpuzzle - v0.0.0 - 2014-05-21
* Copyright (c) 2014 ; Licensed  */
function addInstagramPictures(t,e){function a(){var e=$(this).data("counter");gameUI.setBackground(t.images[e]),gameUIPage.activate()}var n=t.get();n.done(function(){for(var n=$('<div class="pictures">'),i=0;t.thumbnails.length>i;i++){var o=t.thumbnails[i],r=$("<img>").data("counter",i).click(a).attr("src",o);n.append(r)}$(e).replaceWith(n)})}window.configuration={debugMode:!0,clientId:"502ddb21affe4ab3aa2ed53f08c73daa",redirectUrl:"http://localhost:9087"},function(t,e){var a=e.debugMode,n={log:function(t){a&&console.log(t)},dir:function(t){a&&console.dir(t)}};t.Logger=n}(window,window.configuration),function(t){var e=function(){this.events=[]};e.fn=e.prototype,e.fn.bind=function(t,e){return this.events[t]||(this.events[t]=[]),this.events[t].push(e),this},e.fn.trigger=function(t){var e=this.events[t];if(e)for(var a=[].slice.call(arguments,1),n=0,i=e.length;i>n;n++)e[n].apply(this,a);return this},t.Events=e}(window),function(t,e){var a=function(){this.stack=[],this.states=[]};a.fn=a.prototype,a.fn.add=function(t){e.log("StateMachine add "+(""+t));var a=this;this.states.push(t),t.activate=n(t.activate,function(){a.activate(t)}),t.deactivate=n(t.deactivate,function(){a.deactivate(t)})};var n=function(t,e){return"function"!=typeof t&&(t=function(){}),e._fn=t,e};a.fn.activate=function(t){e.log(""+this+" activate "+(""+t));var a=this.stack.slice(-1)[0];a!==t&&($(this.states).each(function(){this!==t&&(e.log(""+this+" deactivating "+(""+this)),this.deactivate._fn())}),$(this.states).each(function(){this===t&&(e.log(""+this+" activating "+(""+this)),this.activate._fn())}),this.stack.push(t))},a.fn.deactivate=function(t){e.log(""+this+" deactivate "+(""+t));var a=this.stack.slice(-1)[0],n=this.stack.slice(-2,-1)[0];a===t&&n&&(this.stack=this.stack.slice(0,-2),this.activate(n))},a.fn.toString=function(){return"[StateMachine]"},t.StateMachine=a}(window,window.Logger),function(t,e){var a=function(t){var a=this,n=!1,i=!1,o=t.elementId,r=$("#"+o),s=function(t){return 27===t.keyCode?(e.log(""+a+" escape pressed"),a.deactivate(),!1):void 0};this.activate=function(){!n&&t.onFirstActivation&&"function"==typeof t.onFirstActivation&&(e.log(""+a+" onFirstActivation"),t.onFirstActivation.apply(a)),$(window).on("keyup",s),n=!0,i=!0,r.removeClass("hidden")},this.deactivate=function(){$(window).off("keyup",s),i=!1,r.addClass("hidden")},this.toString=function(){return"[Page #"+o+"]"};var c=function(){t.stateMachine&&t.stateMachine.add(a),t.onInitialize&&"function"==typeof t.onInitialize&&(e.log(""+a+" onInitialize"),t.onInitialize.apply(a))};c()};t.Page=a}(window,window.Logger),function(t,e){var a=function(t){var a=t.clientId,n=t.redirectUrl,i=t.accessToken,o=t.localStorageNamespace||"instagram",r="https://api.instagram.com/v1/",s="https://instagram.com/oauth/authorize/",c=function(){var t=[s,"?client_id=",encodeURIComponent(a),"&redirect_uri=",encodeURIComponent(n),"&response_type=token"].join("");return t},u=function(t){var e=[r,t,"?access_token=",i,"&callback=?"].join("");return e};this.getAuthenticationToken=function(){var t=c();document.location.href=t};var l=function(){var t=o+"_accessToken";if(i=window.localStorage.getItem(t))e.log("InstagramLibrary parseAuthenticationToken accessToken found");else{var a=document.location.hash,n=a.split("=");2===n.length&&"#access_token"===n[0]?(e.log("InstagramLibrary parseAuthenticationToken accessToken found in url"),i=n[1],window.localStorage.setItem(t,i)):e.log("InstagramLibrary parseAuthenticationToken accessToken not found")}};this.isAuthenticated=function(){return i},this.get=function(t){i||this.getAuthenticationToken();var e=u(t),a=$.getJSON(e);return a},l()},n=function(t){var e=this,a=t.endpoint;this.images=[],this.thumbnails=[],this.get=function(){var t=this.library.get(a);return t.then(function(t){e.images=[],e.thumbnails=[];for(var a=0;t.data.length>a;a++)e.thumbnails.push(t.data[a].images.thumbnail.url),e.images.push(t.data[a].images.standard_resolution.url)}),t}},i=function(t){this.library=t.library};i.prototype=new n({endpoint:"media/popular"});var o=function(t){this.library=t.library};o.prototype=new n({endpoint:"users/self/media/recent"}),t.InstagramLibrary=a,t.InstagramPopular=i,t.InstagramUser=o}(window,window.Logger),function(t){var e=function(t){var a=this,n={top:0,right:1,bottom:2,left:3},i=function(){for(var t=4,e=t*t,a=[],n=0;e-1>n;n++)a.push(n);return a.push(-1),a};t=void 0===t||null===t?i():t.map(function(t){return+t}),this.state=t,this.area=t.length,this.side=Math.sqrt(this.area),this.toString=function(){for(var t="",e=0;this.side>e;e++){for(var a=0;this.side>a;a++){var n=this.state[e*this.side+a],i="   ";null!==n&&(i+=n),t+=i.substring(i.length-3,i.length)}t+="\n"}return t},this.getOpenTile=function(){for(var t,e=0;this.area>e;e++)-1===this.state[e]&&(t=e);return t};var o=function(t){var e=[];return t%a.side-1>=0&&(e[n.left]=t-1),t%a.side+1<a.side&&(e[n.right]=t+1),t-a.side>=0&&(e[n.top]=t-a.side),t+a.side<a.area&&(e[n.bottom]=t+a.side),e};this.getPossibleMoves=function(){for(var t=a.getOpenTile(),e=o(t),n=[],i=0;e.length>i;i++){var r=e[i];void 0!==r&&n.push(r)}return n},this.getMoveUsingDirection=function(t){var e=this.getOpenTile(),a=o(e);return a[n[t]]},this.isSolved=function(){var t=new e;if(this.area!==t.area)return!1;for(var a=0;this.area>a;a++)if(this.state[a]!==t.state[a])return!1;return!0}};t.GameState=e}(window),function(t){var e=function(t){t=$.extend({},t);var e=t.game;this.play=function(t){e.play(t)}};t.Player=e}(window),function(t,e){var a=function(t){t=$.extend({delay:0},t);var a,n=t.game,i=[],o=function(a,n){e.setTimeout(function(){a.call(null,n)},t.delay)};this.play=function(t){return a=new $.Deferred,void 0===t&&(t=1),r(t),a.promise()};var r=function(t){t>0?(s(),o(r,t-1)):a.resolve()},s=function(){var t=n.getGameState(),e=t.getPossibleMoves(),a=u(e),o=c(a);i.push(o),n.play(o)},c=function(t){return t[Math.floor(Math.random()*t.length)]},u=function(t){var e=[],a=null;i.length>=2&&(a=i[i.length-2]);for(var n=0;t.length>n;n++){var o=t[n];o!==a&&e.push(o)}return e}};t.RandomPlayer=a}(window,window),function(t){var e=function(){};t.SolvingPlayer=e}(window),function(t,e,a){var n=function(n){var i=this,o=n||{},r=o.game,s=o.player,c=null,u=!1,l=["right","bottom","left","top"],g=function(t,a){var n,i="tile tile-animated tile-pos-"+t;-1===a?(n=".tile-content-empty",i+=" tile-content-empty"):(n=".tile-content-"+a,i+=" tile-content tile-content-"+a),e(n).attr("class",i)};this.render=function(t){for(var e=0;t.area>e;e++)g(e,t.state[e])};var f=function(t){if(u){var e=d(t.keyCode);if(e){var a=r.getGameState(),n=a.getMoveUsingDirection(e);s.play(n),event.preventDefault()}}},d=function(t){var e=l[t-37];return e},h=function(t){return+t.attr("class").match(/tile-pos-(\d+)/)[1]},v=function(t){if(u){var a,n;"touchstart"===t.type?(a=t.originalEvent.touches[0].pageX,n=t.originalEvent.touches[0].pageY):(a=t.pageX,n=t.pageY),t.originalEvent.preventDefault();var i=e(t.target);if(i.is(".tile-content")){var o=r.getGameState(),s=o.getPossibleMoves(),l=h(i);if(-1!==s.indexOf(l)){i.removeClass("tile-animated");var g=e(".tile-pos-"+o.getOpenTile()),f=i.offset();c={element:i,moved:!1,reverse:!1,move:l,initial:f,maximal:g.offset(),offset:{left:a-f.left,top:n-f.top}}}}}},m=function(t){if(u){var e=function(t,e,a){var n=Math.min(t,e),i=Math.max(t,e);return n>a?n:a>i?i:a},a=function(t,e){var a=Math.abs(t-c.initial.left),n=Math.abs(c.element.offset().left-c.initial.left),i=Math.abs(e-c.initial.top),o=Math.abs(c.element.offset().top-c.initial.top);return-1>a-n||-1>i-o};if(c){var n,i;"touchmove"===t.type?(n=t.originalEvent.touches[0].pageX,i=t.originalEvent.touches[0].pageY):(n=t.pageX,i=t.pageY);var o=e(c.initial.top,c.maximal.top,i-c.offset.top),r=e(c.initial.left,c.maximal.left,n-c.offset.left);c.moved=!0,c.reverse=a(r,o),c.element.offset({top:o,left:r})}}},p=function(t){u&&(t.originalEvent.preventDefault(),c&&(c.moved?(c.element.css("top","").css("left","").addClass("tile-animated"),c.reverse||s.play(c.move)):s.play(c.move),c=null))},w=function(){console.log("solved!")},b=function(){t.localStorage.setItem("slidingpuzzle_gamestate",r.getGameState().state)};this.shuffle=function(){if(u){u=!1;var t=new a({game:r,delay:100});t.play(50).done(function(){u=!0})}};var k=function(){r.bind("init",i.render).bind("move",i.render).bind("move",b).bind("solved",w)},y=function(){e(t).on("keyup",f),e(".puzzle-content").on("mousedown",v).on("mouseup",p).on("mouseleave",p).on("mousemove",m).on("touchstart",v).on("touchmove",m).on("touchend",p).on("touchleave",p)},I=function(){k(),y()};this.setBackground=function(a){var n="url('"+a+"')",i=e("<img>").attr("src",a).load(function(){e(".tile-content").css("background-image",n),e(".status-image").css("background-image",n),i.remove()});t.localStorage.setItem("slidingpuzzle_background",a)};var P=function(){I();var e=t.localStorage.getItem("slidingpuzzle_background");e?i.setBackground(e):i.setBackground(o.background),i.render(r.getGameState()),u=!0};P()};t.GameUI=n}(window,jQuery,window.RandomPlayer),function(t,e,a){var n=function(t){var n=this,i=t||{},o=new a(i.state);$.extend(this,new e),this.getGameState=function(){return new a(o.state.slice())},this.play=function(t){if(-1!==o.getPossibleMoves().indexOf(+t)){var e=o.getOpenTile(),a=o.state[t];o.state[e]=a,o.state[t]=-1,this.trigger("move",n.getGameState()),o.isSolved()&&this.trigger("solved",n.getGameState())}},this.trigger("init",n.getGameState())};t.Game=n}(window,Events,window.GameState);var configuration=window.configuration,state=window.localStorage.getItem("slidingpuzzle_gamestate");state&&(state=state.split(","));var game=new window.Game({state:state}),player=new window.Player({game:game}),gameUI=new window.GameUI({game:game,player:player,background:"assisi.jpeg"}),gameUIPage,instagramLibrary=new InstagramLibrary({clientId:configuration.clientId,redirectUrl:configuration.redirectUrl,localStorageNamespace:"instagram"}),stateMachine=new window.StateMachine,authenticateInstagramPage=new window.Page({elementId:"authenticate",stateMachine:stateMachine}),instagramPopularPage=new window.Page({elementId:"instagrampopular",stateMachine:stateMachine,onInitialize:function(){var t=this;$("#instagrampopular-back").click(t.deactivate)},onFirstActivation:function(){var t=new window.InstagramPopular({library:instagramLibrary}),e="#instagrampopular .pictures";addInstagramPictures(t,e)}}),instagramUserPage=new window.Page({elementId:"instagramuser",stateMachine:stateMachine,onInitialize:function(){var t=this;$("#instagramuser-back").click(t.deactivate)},onFirstActivation:function(){var t=new window.InstagramUser({library:instagramLibrary}),e="#instagramuser .pictures";addInstagramPictures(t,e)}}),backgroundPage=new window.Page({elementId:"background",stateMachine:stateMachine,onInitialize:function(){var t=this;$("#background-back").click(t.deactivate),$("#background-popular").click(instagramPopularPage.activate),$("#background-user").click(instagramUserPage.activate)}}),aboutPage=new window.Page({elementId:"about",stateMachine:stateMachine,onInitialize:function(){var t=this;$("#about-back").click(t.deactivate)}}),menuPage=new window.Page({elementId:"menu",stateMachine:stateMachine,onInitialize:function(){var t=this;$("#menu-back").click(t.deactivate),$("#menu-shuffle").click(function(){gameUI.shuffle(),t.deactivate()}),$("#menu-about").click(aboutPage.activate),$("#menu-background").click(function(){instagramLibrary.isAuthenticated()?backgroundPage.activate():authenticateInstagramPage.activate()})}});gameUIPage=new window.Page({elementId:"puzzle",stateMachine:stateMachine,onInitialize:function(){$("#puzzle-menu").click(function(){menuPage.activate()})}}),gameUIPage.activate();